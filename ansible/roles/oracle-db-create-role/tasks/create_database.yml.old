  - debug:
      msg:
        - 'This task is for Oracle DB Creation, started at {{ansible_date_time.iso8601}}:'
    run_once: true

  - name: rv_oracle_databases dump
    debug:
      msg:
        - '{{ rv_oracle_databases }}'
    when: inventory_hostname in gv_cluster_first_node

  - meta: end_play

  - name: rv_oracle_databases K/V
    debug: msg="{{ item.key }} = {{ item.value }}"
    with_dict: "{{ rv_oracle_databases }}"

  - name: Write
    local_action: copy content={{  rv_oracle_databases | to_nice_yaml() }} dest=/tmp/outv.yml
    when: inventory_hostname in gv_cluster_first_node


  - name : loop over db item
    when: inventory_hostname in gv_cluster_first_node
    ansible.builtin.debug:
       msg: "{{ db_item }}"
    loop: "{{ rv_oracle_databases|flatten(levels=1) }}"
    loop_control:
      index_var: index
      loop_var: db_item
    tags:
      - always

  - name: rv_xmloraHomes dump
    debug:
      msg:
        - '{{ rv_xmloraHomes }}'
    when: inventory_hostname in gv_cluster_first_node

  - name : loop over inv item
    when: inventory_hostname in gv_cluster_first_node
    ansible.builtin.debug:
       msg: "{{ inv_item }}"
    loop: "{{ rv_xmloraHomes|flatten(levels=1) }}"
    loop_control:
      index_var: index
      loop_var: inv_item
    tags:
      - always

  - meta: end_play

  - name : set_fact loop
    set_fact:
      dbproducts: "{{ dbproducts | default([]) + [{ 'home_name' : inner_item.home_name, 'release' : inner_item.release }] }}"
      cacheable: yes
    when: inner_item.type == "database"
    loop: "{{ gv_oracle_products|flatten(levels=1) }}"
    loop_control:
      index_var: index
      loop_var: inner_item
    tags:
      - always

  - name: install database products in a loop
    include_tasks: main.yml 
    loop: "{{ dbproducts }}"
    vars:
      oracle_home_name: "{{ product_item.home_name }}"
      gv_oracle_db_release: "{{ product_item.release }}"
      gv_oracle_home_db: "/u01/app/oracle/product/{{ gv_oracle_db_release }}/dbhome_1"
    loop_control:
      index_var: index
      loop_var: product_item
